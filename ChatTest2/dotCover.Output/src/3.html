<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\andre\Desktop\Repos\dnet_test\ChatTest2\Bidiots.Test\UserControllerTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Threading.Tasks;
using Xunit;
using Bidiots.Entities;
using System.Net.Http;
using Newtonsoft.Json;
using Microsoft.AspNetCore.TestHost;
using Microsoft.AspNetCore.Hosting;
using System.Text;
using System.Diagnostics;
using System;
using Microsoft.Extensions.Configuration;

namespace Bidiots.Test
{
    public class TestsFixture : IDisposable
    {
        public readonly TestServer testServer;
        public readonly HttpClient client;
        protected readonly long timestamp = DateTime.Now.ToFileTime();
        public TestsFixture()
        {
            testServer = new TestServer(new WebHostBuilder()
                .UseStartup&lt;Startup&gt;()
                .UseSetting(&quot;ConnectionStrings:DefaultConnection&quot;, $&quot;Data Source = auctionapp-{timestamp}.db&quot;)
                .UseContentRoot(Environment.CurrentDirectory)
                .UseConfiguration(new ConfigurationBuilder()
                .SetBasePath(Environment.CurrentDirectory)
                .AddJsonFile(&quot;appsettings.json&quot;)
                .Build()));
            client = testServer.CreateClient();
        }

        public void Dispose()
        {
            testServer.Dispose();
            client.Dispose();
        }
    }

    public class UserControllerTest : IClassFixture&lt;TestsFixture&gt;
    {
        private readonly HttpClient client;
        public UserControllerTest(TestsFixture testsFixture)
        {
            client = testsFixture.client;
        }

        [Fact]
        public async Task Given_User_When_InvalidUsername_Then_LoginShouldReturnInvalidCredentials()
        {
            string apiUrl = &quot;http://localhost:63920/api/v1/users/Login&quot;;
            UserModel user = new UserModel() { UserName = &quot;Vlado User Inexistent&quot;, Password = &quot;dmxhZA==&quot; };
            var userJson = new StringContent(JsonConvert.SerializeObject(user), Encoding.UTF8, &quot;application/json&quot;);

            Trace.WriteLine(userJson);

            var response = await client.PostAsync(apiUrl, userJson);

            var statusCode = response.StatusCode;

            Assert.Equal(System.Net.HttpStatusCode.Unauthorized, statusCode);
        }

        [Fact]
        public async Task Given_User_When_InvalidPassword_Then_LoginShouldReturnInvalidCredentials()
        {
            string apiUrl = &quot;http://localhost:63920/api/v1/users/Login&quot;;
            UserModel user = new UserModel() { UserName = &quot;Vlado User Inexistent&quot;, Password = &quot;dmxhZAA==&quot; };
            var userJson = new StringContent(JsonConvert.SerializeObject(user), Encoding.UTF8, &quot;application/json&quot;);

            Trace.WriteLine(userJson);

            var response = await client.PostAsync(apiUrl, userJson);

            var statusCode = response.StatusCode;

            Assert.Equal(System.Net.HttpStatusCode.Unauthorized, statusCode);
        }

        [Fact]
        public async Task Given_User_When_ValidCredentials_Then_LoginShouldReturnOK()
        {
            string apiUrl = &quot;http://localhost:63920/api/v1/users/Login&quot;;
            UserModel user = new UserModel() { UserName = &quot;Vladohtrg2&quot;, Password = &quot;dmxhZA==&quot; };
            var userJson = new StringContent(JsonConvert.SerializeObject(user), Encoding.UTF8, &quot;application/json&quot;);

            Trace.WriteLine(userJson);

            var response = await client.PostAsync(apiUrl, userJson);

            var statusCode = response.StatusCode;

            Assert.Equal(System.Net.HttpStatusCode.OK, statusCode);
        }

        [Fact]
        public async Task Given_User_When_NullUser_Then_LoginShouldReturnBadRequest()
        {
            string apiUrl = &quot;http://localhost:63920/api/v1/users/Login&quot;;
            UserModel user = new();
            var userJson = new StringContent(JsonConvert.SerializeObject(user), Encoding.UTF8, &quot;application/json&quot;);

            Trace.WriteLine(userJson);

            var response = await client.PostAsync(apiUrl, userJson);

            var statusCode = response.StatusCode;

            Assert.Equal(System.Net.HttpStatusCode.BadRequest, statusCode);
        }

        [Fact]
        public async Task Given_User_When_Null_Then_LoginShouldReturnBadRequest()
        {
            string apiUrl = &quot;http://localhost:63920/api/v1/users/Login&quot;;
            UserModel user = null;
            var userJson = new StringContent(JsonConvert.SerializeObject(user), Encoding.UTF8, &quot;application/json&quot;);

            Trace.WriteLine(userJson);

            var response = await client.PostAsync(apiUrl, userJson);

            var statusCode = response.StatusCode;

            Assert.Equal(System.Net.HttpStatusCode.BadRequest, statusCode);
        }

        [Fact]
        public async Task Given_UserModel_When_NewUser_Then_RegisterShouldReturnCreatedStatusCode()
        {
            string apiUrl = &quot;http://localhost:63920/api/v1/users/Register&quot;;
            UserModel user = new UserModel() { UserName = &quot;Vladohtrg2&quot;, Password = &quot;dmxhZA==&quot;, FullName = &quot;Vlado&quot; };
            var userJson = new StringContent(JsonConvert.SerializeObject(user), Encoding.UTF8, &quot;application/json&quot;);

            Trace.WriteLine(userJson);

            var response = await client.PostAsync(apiUrl, userJson);

            var statusCode = response.StatusCode;

            Assert.Equal(System.Net.HttpStatusCode.Created, statusCode);
        }

        [Fact]
        public async Task Given_UserModel_When_ExistingUsername_Then_RegisterShouldReturnConflict()
        {
            string apiUrl = &quot;http://localhost:63920/api/v1/users/Register&quot;;
            UserModel user = new UserModel() { UserName = &quot;Vladohtrg2&quot;, Password = &quot;dmxhZA==&quot;, FullName = &quot;Vlado&quot; };
            var userJson = new StringContent(JsonConvert.SerializeObject(user), Encoding.UTF8, &quot;application/json&quot;);

            Trace.WriteLine(userJson);

            var response = await client.PostAsync(apiUrl, userJson);

            var statusCode = response.StatusCode;

            Assert.Equal(System.Net.HttpStatusCode.Conflict, statusCode);
        }

        [Fact]
        public async Task Given_UserModel_When_NullUser_Then_RegisterShouldReturnBadRequest()
        {
            string apiUrl = &quot;http://localhost:63920/api/v1/users/Register&quot;;
            UserModel user = new();
            var userJson = new StringContent(JsonConvert.SerializeObject(user), Encoding.UTF8, &quot;application/json&quot;);

            Trace.WriteLine(userJson);

            var response = await client.PostAsync(apiUrl, userJson);

            var statusCode = response.StatusCode;

            Assert.Equal(System.Net.HttpStatusCode.BadRequest, statusCode);
        }

        [Fact]
        public async Task Given_UserModel_When_Null_Then_RegisterShouldReturnBadRequest()
        {
            string apiUrl = &quot;http://localhost:63920/api/v1/users/Register&quot;;
            UserModel user = null;
            var userJson = new StringContent(JsonConvert.SerializeObject(user), Encoding.UTF8, &quot;application/json&quot;);

            Trace.WriteLine(userJson);

            var response = await client.PostAsync(apiUrl, userJson);

            var statusCode = response.StatusCode;

            Assert.Equal(System.Net.HttpStatusCode.BadRequest, statusCode);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,71,1],[20,9,20,30,1],[21,9,21,10,1],[22,13,29,28,1],[30,13,30,48,1],[31,9,31,10,1],[34,9,34,10,1],[35,13,35,34,1],[36,13,36,30,1],[37,9,37,10,1],[43,9,43,61,1],[44,9,44,10,1],[45,13,45,42,1],[46,9,46,10,1],[50,9,50,10,1],[51,13,51,73,1],[52,13,52,108,1],[53,13,53,116,1],[55,13,55,39,1],[57,13,57,69,1],[59,13,59,50,1],[61,13,61,78,1],[62,9,62,10,1],[66,9,66,10,1],[67,13,67,73,1],[68,13,68,109,1],[69,13,69,116,1],[71,13,71,39,1],[73,13,73,69,1],[75,13,75,50,1],[77,13,77,78,1],[78,9,78,10,1],[82,9,82,10,1],[83,13,83,73,1],[84,13,84,97,1],[85,13,85,116,1],[87,13,87,39,1],[89,13,89,69,1],[91,13,91,50,1],[93,13,93,68,1],[94,9,94,10,1],[98,9,98,10,1],[99,13,99,73,1],[100,13,100,36,1],[101,13,101,116,1],[103,13,103,39,1],[105,13,105,69,1],[107,13,107,50,1],[109,13,109,76,1],[110,9,110,10,1],[114,9,114,10,1],[115,13,115,73,1],[116,13,116,35,1],[117,13,117,116,1],[119,13,119,39,1],[121,13,121,69,1],[123,13,123,50,1],[125,13,125,76,1],[126,9,126,10,1],[130,9,130,10,1],[131,13,131,76,1],[132,13,132,117,1],[133,13,133,116,1],[135,13,135,39,1],[137,13,137,69,1],[139,13,139,50,1],[141,13,141,73,1],[142,9,142,10,1],[146,9,146,10,1],[147,13,147,76,1],[148,13,148,117,1],[149,13,149,116,1],[151,13,151,39,1],[153,13,153,69,1],[155,13,155,50,1],[157,13,157,74,1],[158,9,158,10,1],[162,9,162,10,1],[163,13,163,76,1],[164,13,164,36,1],[165,13,165,116,1],[167,13,167,39,1],[169,13,169,69,1],[171,13,171,50,1],[173,13,173,76,1],[174,9,174,10,1],[178,9,178,10,1],[179,13,179,76,1],[180,13,180,35,1],[181,13,181,116,1],[183,13,183,39,1],[185,13,185,69,1],[187,13,187,50,1],[189,13,189,76,1],[190,9,190,10,1]]);
    </script>
  </body>
</html>