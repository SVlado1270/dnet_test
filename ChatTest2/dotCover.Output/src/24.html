<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\andre\Desktop\Repos\dnet_test\ChatTest2\ChatTest2\Hubs\MessageHub.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using AutoMapper;
using Bidiots.Mappings;
using Bidiots.Models;
using Bidiots.Repository;
using Bidiots.ViewModels;
using Microsoft.AspNetCore.SignalR;
using Microsoft.Extensions.DependencyInjection;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace Bidiots.Hubs
{
    public class MessageHub : Hub
    {
        public readonly static List&lt;UserViewModel&gt; _Connections = new List&lt;UserViewModel&gt;();
        public readonly static List&lt;RoomViewModel&gt; _Rooms = new List&lt;RoomViewModel&gt;();
        private readonly static Dictionary&lt;string, string&gt; _ConnectionsMap = new Dictionary&lt;string, string&gt;();

        protected readonly IMapper _mapper;
        protected readonly IRepositoryWrapper _repositoryWrapper;

        [ActivatorUtilitiesConstructor]
        public MessageHub(IRepositoryWrapper repositoryWrapper, IMapper mapper)
        {
            _repositoryWrapper = repositoryWrapper;
            _mapper = mapper;
        }

        public MessageHub(DataContext dataContext)
        {
            _repositoryWrapper = new RepositoryWrapper(dataContext);
            var messageMapper = new MessageMapper();
            var roomMapper = new RoomMapper();
            var userMapper = new UserMapper();
            var configuration = new MapperConfiguration(cfg =&gt; cfg.AddProfile(messageMapper));
            configuration = new MapperConfiguration(cfg =&gt; cfg.AddProfile(roomMapper));
            configuration = new MapperConfiguration(cfg =&gt; cfg.AddProfile(userMapper));
            _mapper = new Mapper(configuration);
        }

        public async Task CreateRoom(string roomName, string userName)
        {
            try
            {
                Match match = Regex.Match(roomName, @&quot;^\w+( \w+)*$&quot;);
                if (!match.Success)
                {
                    await Clients.Caller.SendAsync(&quot;onError&quot;, &quot;Invalid room name!\nRoom name must contain only letters and numbers.&quot;);
                }
                else if (roomName.Length &lt; 5 || roomName.Length &gt; 100)
                {
                    await Clients.Caller.SendAsync(&quot;onError&quot;, &quot;Room name must be between 5-100 characters!&quot;);
                }
                else if (_repositoryWrapper.Room.FindByCondition(r =&gt; r.Name == roomName).Any())
                {
                    await Clients.Caller.SendAsync(&quot;onError&quot;, &quot;Another chat room with this name exists&quot;);
                }
                else
                {
                    var user = _repositoryWrapper.User.GetUserByNameAsync(userName).Result;
                    if (user == null)
                    {
                        await Clients.Caller.SendAsync(&quot;onError&quot;, &quot;User not found&quot;);
                    }
                    else
                    {
                        var room = new Room()
                        {
                            Name = roomName,
                            OwnerId = user.Id
                        };
                        _repositoryWrapper.Room.CreateRoom(room);
                        await _repositoryWrapper.SaveAsync();
                    }
                }
            }
            catch (Exception ex)
            {
                await Clients.Caller.SendAsync(&quot;onError&quot;, &quot;Couldn&#39;t create chat room: &quot; + ex.Message);
            }
        }

        public async Task JoinRoom(string roomName, string userName)
        {
            try
            {
                var user = _repositoryWrapper.User.FindByCondition(u =&gt; u.UserName == userName).FirstOrDefault();
                if (user != null &amp;&amp; user.Room != roomName)
                {
                    /*// Remove user from others list
                    if (!string.IsNullOrEmpty(user.CurrentRoom))
                        await Clients.OthersInGroup(user.CurrentRoom).SendAsync(&quot;removeUser&quot;, user);*/

                    // Join to new chat room
                    //await Leave(user.CurrentRoom);
                    await Groups.AddToGroupAsync(Context.ConnectionId, roomName);
                    user.Room = roomName;
                    _repositoryWrapper.User.UpdateUser(user);
                    await _repositoryWrapper.SaveAsync();

                    // Tell others to update their list of users
                    // await Clients.OthersInGroup(roomName).SendAsync(&quot;addUser&quot;, user); -&gt; Ca sa actualizezi pe front interfata
                }
            }
            catch (Exception ex)
            {
                await Clients.Caller.SendAsync(&quot;onError&quot;, &quot;You failed to join the chat room!&quot; + ex.Message);
            }
        }

        public async Task DeleteRoom(string roomName, string userName)
        {
            try
            {
                // Delete from database
                var user = _repositoryWrapper.User.FindByCondition(u =&gt; u.UserName == userName).FirstOrDefault();
                var room = _repositoryWrapper.Room.FindByCondition(r =&gt; r.Name == roomName &amp;&amp; r.OwnerId == user.Id).FirstOrDefault();
                _repositoryWrapper.Room.DeleteRoom(room);
                await _repositoryWrapper.SaveAsync();


                // Move users back to Lobby
                //await Clients.Group(roomName).SendAsync(&quot;onRoomDeleted&quot;, string.Format(&quot;Room {0} has been deleted.\nYou are now moved to the Lobby!&quot;, roomName));

                // Tell all users to update their room list
                //await Clients.All.SendAsync(&quot;removeChatRoom&quot;, roomViewModel);
            }
            catch (Exception)
            {
                await Clients.Caller.SendAsync(&quot;onError&quot;, &quot;Can&#39;t delete this chat room. Only owner can delete this room.&quot;);
            }
        }

        public async Task LeaveRoom(string roomName, string userName)
        {
            try
            {
                // Delete from database
                var user = _repositoryWrapper.User.FindByCondition(u =&gt; u.UserName == userName).FirstOrDefault();

                if (user.Room == roomName)
                {
                    await Groups.RemoveFromGroupAsync(Context.ConnectionId, roomName);
                    user.Room = null;
                    _repositoryWrapper.User.UpdateUser(user);
                    await _repositoryWrapper.SaveAsync();
                }
                // Move users back to Lobby
                //await Clients.Group(roomName).SendAsync(&quot;onRoomDeleted&quot;, string.Format(&quot;Room {0} has been deleted.\nYou are now moved to the Lobby!&quot;, roomName));

                // Tell all users to update their room list
                //await Clients.All.SendAsync(&quot;removeChatRoom&quot;, roomViewModel);
            }
            catch (Exception)
            {
                await Clients.Caller.SendAsync(&quot;onError&quot;, &quot;Can&#39;t delete this chat room. Only owner can delete this room.&quot;);
            }
        }

        public async Task&lt;IEnumerable&lt;Room&gt;&gt; GetActiveRooms()
        {
            return await _repositoryWrapper.Room.GetAllRoomsAsync();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,93,0],[19,9,19,87,0],[20,9,20,111,0],[26,9,26,80,0],[27,9,27,10,0],[28,13,28,52,0],[29,13,29,30,0],[30,9,30,10,0],[32,9,32,51,1],[33,9,33,10,1],[34,13,34,69,1],[35,13,35,53,1],[36,13,36,47,1],[37,13,37,47,1],[38,13,38,64,1],[38,64,38,93,1],[38,93,38,95,1],[39,13,39,60,1],[39,60,39,86,1],[39,86,39,88,1],[40,13,40,60,1],[40,60,40,86,1],[40,86,40,88,1],[41,13,41,49,1],[42,9,42,10,1],[45,9,45,10,1],[47,13,47,14,1],[48,17,48,70,1],[49,17,49,36,1],[50,17,50,18,0],[51,21,51,135,0],[52,17,52,18,0],[53,22,53,71,1],[54,17,54,18,0],[55,21,55,110,0],[56,17,56,18,0],[57,22,57,97,1],[58,17,58,18,0],[59,21,59,106,0],[60,17,60,18,0],[62,17,62,18,1],[63,21,63,92,1],[64,21,64,38,1],[65,21,65,22,1],[66,25,66,85,1],[67,21,67,22,1],[69,21,69,22,1],[70,25,74,27,1],[75,25,75,66,1],[76,25,76,62,1],[77,21,77,22,1],[78,17,78,18,1],[79,13,79,14,1],[80,13,80,33,0],[81,13,81,14,0],[82,17,82,103,0],[83,13,83,14,0],[84,9,84,10,1],[87,9,87,10,0],[89,13,89,14,0],[90,17,90,114,0],[91,17,91,59,0],[92,17,92,18,0],[99,21,99,82,0],[100,21,100,42,0],[101,21,101,62,0],[102,21,102,58,0],[106,17,106,18,0],[107,13,107,14,0],[108,13,108,33,0],[109,13,109,14,0],[110,17,110,109,0],[111,13,111,14,0],[112,9,112,10,0],[115,9,115,10,0],[117,13,117,14,0],[119,17,119,114,0],[120,17,120,134,0],[121,17,121,58,0],[122,17,122,54,0],[130,13,130,14,0],[131,13,131,30,0],[132,13,132,14,0],[133,17,133,124,0],[134,13,134,14,0],[135,9,135,10,0],[138,9,138,10,0],[140,13,140,14,0],[142,17,142,114,0],[144,17,144,43,0],[145,17,145,18,0],[146,21,146,87,0],[147,21,147,38,0],[148,21,148,62,0],[149,21,149,58,0],[150,17,150,18,0],[156,13,156,14,0],[157,13,157,30,0],[158,13,158,14,0],[159,17,159,124,0],[160,13,160,14,0],[161,9,161,10,0],[164,9,164,10,0],[165,13,165,69,0],[166,9,166,10,0]]);
    </script>
  </body>
</html>